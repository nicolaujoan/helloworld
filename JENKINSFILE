pipeline {
    agent any

    stages {
        stage('Get Code') {
            steps {
                // Obtener cÃ³digo del repo
                git 'https://github.com/nicolaujoan/helloworld.git'
                sh 'ls -la'
                sh 'echo "Workspace: ${WORKSPACE}"'
            }
        }

        stage('Tests') {
            parallel {
                stage('Unit') {
                    steps {
                        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                            sh '''
                                cd "${WORKSPACE}"
                                export PYTHONPATH="${WORKSPACE}"
                                python3 -m coverage run --branch --source=app -m pytest --junitxml=result-unit.xml test/unit
                                python3 -m coverage xml -o coverage.xml
                                python3 -m coverage report
                            '''
                            junit 'result-unit.xml'
                            publishCoverage adapters: [coberturaAdapter('coverage.xml')],
                                sourceFileResolver: sourceFiles('STORE_LAST_BUILD'),
                                sourceDirectories: [[path: '.']],
                                globalThresholds: [[thresholdTarget: 'Line', unhealthyThreshold: 85.0, unstableThreshold: 95.0],
                                                   [thresholdTarget: 'Conditional', unhealthyThreshold: 80.0, unstableThreshold: 90.0]]
                        }
                    }
                }

                stage('Rest') {
                    steps {
                        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                            sh '''
                                cd "${WORKSPACE}"

                                # Stop any existing services
                                ./stop_wiremock.sh || true
                                ./stop_flask.sh || true

                                # Start Flask
                                export FLASK_APP="${WORKSPACE}/app/api.py"
                                python3 -m flask run --port 5000 > flask.log 2>&1 &

                                ./start_wiremock.sh

                                # Wait for services to be ready
                                sleep 10

                                # Run tests
                                export PYTHONPATH="${WORKSPACE}"
                                python3 -m pytest --junitxml=result-rest.xml test/rest

                                # Cleanup
                                ./stop_wiremock.sh
                                ./stop_flask.sh
                            '''
                            junit 'result-rest.xml'
                        }
                    }
                }

                stage('Static') {
                    steps {
                        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                            sh '''
                                cd "${WORKSPACE}"
                                python3 -m flake8 --exit-zero --format=pylint app > flake8.out || true
                            '''
                            recordIssues tools: [flake8(name: 'Flake8', pattern: 'flake8.out')],
                                qualityGates: [
                                    [threshold: 8, type: 'TOTAL', unstable: true],
                                    [threshold: 10, type: 'TOTAL', failure: true]
                                ]
                        }
                    }
                }

                stage('Security') {
                    steps {
                        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                            sh '''
                                cd "${WORKSPACE}"
                                python3 -m bandit -r app -f custom -o bandit.out --msg-template "{abspath}:{line}: [{test_id}] {msg}" || true
                            '''
                            recordIssues tools: [pyLint(name: 'Bandit', pattern: 'bandit.out')],
                                qualityGates: [
                                    [threshold: 2, type: 'TOTAL', unstable: true],
                                    [threshold: 4, type: 'TOTAL', failure: true]
                                ]
                        }
                    }
                }
            }
        }

        stage('Performance') {
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    sh '''
                        cd "${WORKSPACE}"

                        # Stop any existing Flask
                        ./stop_flask.sh || true

                        # Start Flask for performance tests
                        export FLASK_APP="${WORKSPACE}/app/api.py"
                        python3 -m flask run --port 5000 > flask_perf.log 2>&1 &

                        # Wait for Flask to be ready
                        sleep 5

                        # Run JMeter tests
                        /opt/jmeter/bin/jmeter -n -t test/jmeter/flask.jmx -l results.jtl -e -o jmeter-report/

                        # Cleanup
                        ./stop_flask.sh
                    '''
                    perfReport sourceDataFiles: 'results.jtl'
                }
            }
        }
    }
}