pipeline {
    agent any

     stages {
        stage('Get Code') {
            steps {
                // Obtener cÃ³digo del repo
                git 'https://github.com/nicolaujoan/helloworld.git'
                sh 'ls -la'
                sh 'echo "Workspace: ${WORKSPACE}"'
            }
        }

        stage('Build') {
           steps {
              echo 'Eyyy, esto es Python. No hay que compilar nada!!!'
           }
        }

        stage('Tests')
        {
            parallel
            {

                stage('Unit') {
                            steps {
                                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                                    sh '''
                                        cd "${WORKSPACE}"
                                        export PYTHONPATH="${WORKSPACE}"
                                        python3 -m pytest --junitxml=result-unit.xml test/unit
                                    '''
                                }
                            }
                }


                stage('Rest') {
                    steps {
                        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                            sh '''
                                cd "${WORKSPACE}"

                                # Stop any existing services
                                ./stop_wiremock.sh || true
                                ./stop_flask.sh || true

                                # Start Flask
                                export FLASK_APP="${WORKSPACE}/app/api.py"
                                python3 -m flask run --port 5000 > flask.log 2>&1 &

                                ./start_wiremock.sh

                                # Wait for services to be ready
                                sleep 10

                                # Run tests
                                export PYTHONPATH="${WORKSPACE}"
                                python3 -m pytest --junitxml=result-rest.xml test/rest

                                # Cleanup
                                ./stop_wiremock.sh
                                ./stop_flask.sh
                            '''
                        }
                    }
                }
            }
        }

        stage ('Results') {
            steps {
                junit 'result*.xml'
            }
        }
     }
}